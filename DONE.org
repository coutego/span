#+title: Done

* DONE Refactor: move package functionality to org-chronos.el
There is code hanging around that should be in org-chronos.
For example:

#+begin_src emacs-lisp
(defgroup org-chronos nil
  "Event-sourced time tracking for Org-mode."
  :group 'org
  :prefix "chronos-")

(defcustom chronos-log-directory (expand-file-name "chronos-logs" user-emacs-directory)
  "Directory for storing chronos event logs."
  :type 'directory
  :group 'org-chronos)

(defconst chronos-event-priorities
  '(:day-start 0 :stop 10 :interruption 20 :ctx-switch 30 :tick 40)
  "Event type priorities for sorting.")
#+end_src


* DONE Feature: break implementation in separate files
For development convenience, clarity and to keep files short
break down the implementation of org-chronos in different files.
On possible idea:
- org-chronos-interfaces.el
  All the interfaces (and perhaps the data structures the interfaces use)
- org-chronos-persistence.el Code related to persistence (default implementation of the
  persistence interface + any other alternative implementation that
  might already exist, auxiliary functions, ...)
- org-chronos-event-log.el
  Idem, for the corresponding interface
- org-chronos-app-state.el
  Idem, for the corresponding interface
- org-chronos-renderer.el
  Idem, for the corresponding interface
- org-chronos-ui.el
  UI of the application, event handlers, evil-mode, etc.
- org-chronos.el
  Package mode like defgroup declarations, set-up of the IoC
  container, setting any global variable, etc.

Remember to updade the dev-load.el file and to create different test files for different files (for those that need to have tests,
which excludes the org-chronos-interfaces.el and org-chronos.el
files, at least)

* DONE Feature: break implementation in separate files
For development convenience, clarity and to keep files short
break down the implementation of org-chronos in different files.
On possible idea:
- org-chronos-interfaces.el
  All the interfaces (and perhaps the data structures the interfaces use)
- org-chronos-persistence.el Code related to persistence (default implementation of the
  persistence interface + any other alternative implementation that
  might already exist, auxiliary functions, ...)
- org-chronos-event-log.el
  Idem, for the corresponding interface
- org-chronos-app-state.el
  Idem, for the corresponding interface
- org-chronos-renderer.el
  Idem, for the corresponding interface
- org-chronos-ui.el
  UI of the application, event handlers, evil-mode, etc.
- org-chronos.el
  Package mode like defgroup declarations, set-up of the IoC
  container, setting any global variable, etc.

Remember to updade the dev-load.el file and to create different test files for different files (for those that need to have tests,
which excludes the org-chronos-interfaces.el and org-chronos.el
files, at least)

* DONE Refactor: move all setup code to org-chronos.el
Currently, org-chronos-ui.el has setup code that doesn't
belong there (in my opinion). For example:

#+begin_src

;;; ============================================================================
;;; IoC Container Setup
;;; ============================================================================

#+end_src

I don't think the IoC setup belongs here, does it? The UI should be able to be used even without container, as long
as the right objects are passed to the right function (rather than looked up)

#+begin_src

;;;###autoload
(defun chronos ()
  "Open the Org-Chronos time tracker."
  (interactive)
  (chronos--ensure-initialized)
  (let* ((app-state (eli-container-resolve chronos--container 'chronos-app-state))
         (renderer (eli-container-resolve chronos--container 'chronos-renderer))
         (vm (chronos-app-state/get-view-model app-state))
         (buf (chronos-renderer/render renderer vm)))
    (switch-to-buffer buf)))
#+end_src

All functions exposed to the general environment, especially this one, but any other that is interactive would
seem to belong in org-chronos.el.

On the other hand, I'm not sure there is any need for the "test" code in org-chronos.el. Check whether is needed at
all, and drop it if needed.

Perhaps there is no actual need for the org-chronos-ui.el file and everything should be in org-chronos.el.

* DONE Refactor: move all setup code to org-chronos.el
Currently, org-chronos-ui.el has setup code that doesn't
belong there (in my opinion). For example:

#+begin_src

;;; ============================================================================
;;; IoC Container Setup
;;; ============================================================================

#+end_src

I don't think the IoC setup belongs here, does it? The UI should be able to be used even without container, as long
as the right objects are passed to the right function (rather than looked up)

#+begin_src

;;;###autoload
(defun chronos ()
  "Open the Org-Chronos time tracker."
  (interactive)
  (chronos--ensure-initialized)
  (let* ((app-state (eli-container-resolve chronos--container 'chronos-app-state))
         (renderer (eli-container-resolve chronos--container 'chronos-renderer))
         (vm (chronos-app-state/get-view-model app-state))
         (buf (chronos-renderer/render renderer vm)))
    (switch-to-buffer buf)))
#+end_src

All functions exposed to the general environment, especially this one, but any other that is interactive would
seem to belong in org-chronos.el.

On the other hand, I'm not sure there is any need for the "test" code in org-chronos.el. Check whether is needed at
all, and drop it if needed.

Perhaps there is no actual need for the org-chronos-ui.el file and everything should be in org-chronos.el.

* DONE Feature: ask for time when starting the day
When executing the command to start the day, ask for the time that it should be started at, defaulting to the current time and allowing both an absolute time (HH:MM)
or a relative time (-20) (indicating 20 minutes ago)

* DONE Refactor: move all setup code to org-chronos.el
Currently, org-chronos-ui.el has setup code that doesn't
belong there (in my opinion). For example:

#+begin_src

;;; ============================================================================
;;; IoC Container Setup
;;; ============================================================================

#+end_src

I don't think the IoC setup belongs here, does it? The UI should be able to be used even without container, as long
as the right objects are passed to the right function (rather than looked up)

#+begin_src

;;;###autoload
(defun chronos ()
  "Open the Org-Chronos time tracker."
  (interactive)
  (chronos--ensure-initialized)
  (let* ((app-state (eli-container-resolve chronos--container 'chronos-app-state))
         (renderer (eli-container-resolve chronos--container 'chronos-renderer))
         (vm (chronos-app-state/get-view-model app-state))
         (buf (chronos-renderer/render renderer vm)))
    (switch-to-buffer buf)))
#+end_src

All functions exposed to the general environment, especially this one, but any other that is interactive would
seem to belong in org-chronos.el.

On the other hand, I'm not sure there is any need for the "test" code in org-chronos.el. Check whether is needed at
all, and drop it if needed.

Perhaps there is no actual need for the org-chronos-ui.el file and everything should be in org-chronos.el.

* DONE Feature: ask for time when starting the day
When executing the command to start the day, ask for the time that it should be started at, defaulting to the current time and allowing both an absolute time (HH:MM)
or a relative time (-20) (indicating 20 minutes ago)

* DONE Feature: keep all actions, even when deactivated
Since actions change dynamically, things move vertically
when the buffer window is narrow (because of line breaks).
In order to avoid that, one possibility is to just keep all
the actions always visible, but to activate and deactivate them
as needed. When deactivated, it should be clearly visible (for
example, by making the font gray / shaded)

* DONE Feature: break implementation in separate files
For development convenience, clarity and to keep files short
break down the implementation of org-chronos in different files.
On possible idea:
- org-chronos-interfaces.el
  All the interfaces (and perhaps the data structures the interfaces use)
- org-chronos-persistence.el Code related to persistence (default implementation of the
  persistence interface + any other alternative implementation that
  might already exist, auxiliary functions, ...)
- org-chronos-event-log.el
  Idem, for the corresponding interface
- org-chronos-app-state.el
  Idem, for the corresponding interface
- org-chronos-renderer.el
  Idem, for the corresponding interface
- org-chronos-ui.el
  UI of the application, event handlers, evil-mode, etc.
- org-chronos.el
  Package mode like defgroup declarations, set-up of the IoC
  container, setting any global variable, etc.

Remember to updade the dev-load.el file and to create different test files for different files (for those that need to have tests,
which excludes the org-chronos-interfaces.el and org-chronos.el
files, at least)

* DONE Feature: implement linking org-mode headlines to tasks
Use CHRONOS_ID properties to keep links to tasks (headlines)
in chronos.

A previous implementation of the feature used the code in temp.el.
Now that functionality should live behing an eli.el interface and
be used through the IoC, without having to depend on the implementation.

This task includes the design and creation of the interface to be used,  and
writing tests for that implementation.

* DONE Feature: create a command to clock in and link heading
When I am in a heading anywhere in an org-mode task, allow to
run a command that creates a CHRONOS_ID to the heading, put it
in the linker system and clock-in in chronos, linking the task
to the newly created entry

* DONE Feature: implement "Go to heading"
:PROPERTIES:
:CHRONOS_ID: 2fe9501e-a005-42f7-9c15-7605bd8706ee
:END:
I get an error "Go to heading not yet implemented"

* DONE Bug: "Go to heading" doesn't work
I have this task:

#+begin_src org
,* DONE Feature: implement "Go to heading"
:PROPERTIES:
:CHRONOS_ID: 2fe9501e-a005-42f7-9c15-7605bd8706ee
:END:
I get an error "Go to heading not yet implemented"
#+end_src

There is a CHRONOS_ID because I run chronos-clock-in-current-heading. Nevertheless,
when I'm on the task:

#+begin_quote
══════════════════════════════════════════
              ORG-CHRONOS
══════════════════════════════════════════

  Saturday, November 29, 2025

  Status: Active
  Current: Feature: implement "Go to heading" (0h 8m)

  [s] Start Day  [c] Clock In  [o] Clock Out  [i] Interrupt  [t] Tick  [f] Fill Gap
  [D] Delete  [e] Edit Time  [RET] Go to Heading  [n] Next Day  [p] Prev Day  [T] Go to Date
  [r] Refresh  [q] Quit

  --------------- Timeline ---------------

    00:49 - 00:49   Foo
    00:49 - 00:49   First task in the day
    00:49 - 00:50   Sleeping
    00:50 - 02:20   [Gap]
    02:20 - 17:03   New task after long pause
    17:03 -  now    Feature: implement "Go to heading"
#+end_quote

If I press RET on Feature: implement "Go to heading", I get an error:

Selected item is not a task
