#+title: Implemented

* DONE Feature: bold face for tasks in the dashboard
The tasks in the dashboard should be shown in bold, rathen than regular font
to make the pop out easier


* DONE Bug: duplicated tasks shown in the dashboard
When clocking in a new task 'Tarefa 2', the task is shown twice:

[ TIMELINE ]
   20:27 - 20:28   Tarefa 1
   20:28 -  ...    Tarefa 2
   20:28 -  ...    Tarefa 2

When clocking in another task, the ducplication dissapears:


[ STATUS ]
   Active:  New task
   Elapsed: 0m


[ ACTIONS ]
   [c] Clock In   [i] Interrupt   [t] Tick   [r] Refresh   [q] Quit

[ TIMELINE ]
   20:27 - 20:28   Tarefa 1
   20:28 - 20:33   Tarefa 2
   20:33 -  ...    New task
      ID: 800f90b7-659f-4494-9135-c5ee0ed0954b
      Type: :ctx-switch
   20:33 -  ...    New task

* DONE Feature: implement the 'clock out' command
It must be extremelly realiable, guiding the user if any
conflict or question is found

* DONE Feature: make 'clock in' command to offer current heading
Add a new option to the clock in command, when in an org-mode buffer
to clock in the current heading

* DONE Bug: 'clock-in' changes buffer even if not in the dashboard
When the clock-in command is run, and 'Manual Find / Navigate to file' is selected,
the previous buffer is visited rather than staying in the current one.

* DONE Bug: 'Tick' doesn't do anything
When pressing 't' in the dashboard a '1>' is shown in the modeline and nothing
happens

* DONE Bug: empty periods of time are not indicated
One of the design choices of the system is to very clearly visually
indicate any period that is not attributed to any task. The idea is to
show that period in red (or similar effect) and indicate in the text
clearly that the text is not attributed (with something like '<not attributed>')

Currently this doesn't happen:


#+begin_quote
ORG-CHRONOS  ::  Tuesday, November 25, 2025
============================================================
[ STATUS ]
   Active:  Foobar
   Elapsed: 0m


[ ACTIONS ]
   [c] Clock In   [o] Clock Out   [i] Interrupt   [t] Tick   [r] Refresh   [q] Quit

[ TIMELINE ]
   20:27 - 20:28   Tarefa 1
      ID: e8090842-0e23-4a79-b20a-7d5bba4f0d4a
      Type: :ctx-switch
   20:28 - 20:33   Tarefa 2
      ID: 0caa9b34-bcd0-4c35-925c-bda70851043e
      Type: :ctx-switch
   20:33 - 20:47   New task
      ID: 800f90b7-659f-4494-9135-c5ee0ed0954b
      Type: :ctx-switch
   20:47 - 20:53   tODO Another task to clock in
      ID: 23b29677-9b6e-44c2-8e4c-2d14c461db54
      Type: :ctx-switch
   20:53 - 20:53   Extra task
      ID: 1103aa20-0ac3-4fbf-a6f9-7b16c94cf7ba
      Type: :ctx-switch
   20:58 -  ...    Foobar
   #+end_quote

* DONE Feature: make 'refresh' refresh the titles of the tasks
Then a title of a heading changes, make the dashboard to also change it when
refreshing. If this is potentially slow, add a second refresh command ("Hard refresh"?)
that does this. Perhaps the shortcut might be 'R'?

* DONE Bug: error when running org-chronos-status
This is printed in *Messages*

An error occurred in diff-hl--update: (wrong-type-argument stringp nil) [5 times]
format: Wrong type argument: stringp, nil


* DONE Bug: the list of actions overflows to the right if buffer view is narrow
For example, in this case the view is cut after 'Qu':

ORG-CHRONOS  ::  Wednesday, November 26, 2025
============================================================
[ STATUS ]
   Active:  Nothing


[ ACTIONS ]
   [c] Clock In   [o] Clock Out   [i] Interrupt   [t] Tick   [r] Refresh   [R] Hard Refresh   [q] Quit

[ TIMELINE ]

* DONE Feature: design the statuses, actions per status and transitions
- If there are no tasks logged in a day, the only action should be 'Start Day'
- New actions should be created:
  - Start Day
  - Finish Day
  - Produce Report
- If the cursor is over a task, at least these actions should be available:
  - Delete Time
  - Split Time (the user should be able to chose the split time, whether to keep the task at the beginning or at the end and chose or create a task)
  - Change duration (time can be taken from previous or next time)
  - Refresh

Design the detailed list of possible statuses of org-chronos, the substatuses (depending on the row selected, etc.), the actions in each (sub)status and
the transition between them

* DONE Feature: Core - Implement Global State Logic
Update `org-chronos-compute-day` in `org-chronos-core.el` to determine the global state of the day based on the last event.
States defined in DESIGN.md:
- PRE-START (No events)
- ACTIVE (Last event: DAY_START or CTX_SWITCH)
- INTERRUPTED (Last event: INTERRUPTION)
- FINISHED (Last event: STOP)

* DONE Feature: UI - Dynamic Action Strip
Refactor `org-chronos--insert-action-strip` in `org-chronos-ui.el`.
It should accept the global state computed in the previous task and render the specific keys/actions defined in DESIGN.md (Section 4).
- PRE-START: [s] Start, [n/p] Nav, [q] Quit
- ACTIVE: [c] Clock In, [o] Out, [i] Interrupt, [t] Tick, [r] Refresh, [R] Report, [q] Quit
- FINISHED: [c] Resume, [R] Report, [q] Quit

* DONE Feature: Input - Implement Start Day and Date Navigation
1. Implement `org-chronos-start-day`: Logs a `DAY_START` event.
2. Implement `org-chronos-prev-day` and `org-chronos-next-day`:
   - Needs a buffer-local variable or global variable to track the "viewed date" (currently defaults to today).
   - Refresh dashboard with new date.

* DONE Feature: Input - Contextual Timeline Actions (Delete/Merge)
Implement logic to act on the specific interval under the cursor in the dashboard.
- `[d] Delete`: Identify the event that started the current interval and remove it from the log.
- `[M] Merge Up`: Effectively the same as delete (merges current time into previous block).

* DONE Feature: Input - Contextual Timeline Actions (Split/Edit)
- `[S] Split`: Prompt user for a time within the selected interval. Insert a new `CTX_SWITCH` event at that time.
- `[e] Edit Time`: Allow modifying the timestamp of the event that started the selected interval.

* DONE Feature: Input - Gap Filling
- `[f] Fill Gap`: When cursor is on a Gap (red block), allow inserting a `CTX_SWITCH` at the start of that gap to retroactively log work.

* DONE Bug: no contextual tasks are shown.
The ACTIONS menu is fixed, no matter what line the cursor is in. In particular,
when the cursor is placed over an Unresolved time, no 'f' command is shown, but it also happens for all others


* DONE Feature: Core - Implement Global State Logic
Update `org-chronos-compute-day` in `org-chronos-core.el` to determine the global state of the day based on the last event.
States defined in DESIGN.md:
- PRE-START (No events)
- ACTIVE (Last event: DAY_START or CTX_SWITCH)
- INTERRUPTED (Last event: INTERRUPTION)
- FINISHED (Last event: STOP)

* DONE Bug: some shortcuts don't work
Those are: 's', 't', 'f'. It seems that they have in common that are evil motion commands. I think that evil shortcuts are conflicting with the commands defined by this package

* DONE Bug: evil navigation keys don't work
Now, when pression 'j' or 'k', I get a message:

k is undefined [2 times]
j is undefined [2 times]

* Refactor: Phase 1 - Persistence Layer
** DONE Implement pure FS functions
Create `org-chronos-fs.el` (or add to core) with:
- `(chronos-fs-read date)`: Returns list of sexps.
- `(chronos-fs-write date events)`: Writes list to file.
** DONE Test Persistence Layer
Create `tests/test-persistence.el`:
- Test round-trip serialization.
- Test handling of empty files or malformed lines.

* Refactor: Phase 2 - Domain Layer
** DONE Refactor Core to Pure Functions
Ensure `org-chronos-core.el` contains:
- `(chronos-add-event events type payload time)` -> new list
- `(chronos-delete-event events timestamp)` -> new list
- `(chronos-update-event events old-ts new-ts)` -> new list
- `(chronos-reduce-events events)` -> view-model plist
** DONE Test Domain Logic
Create `tests/test-domain.el`:
- Test adding/deleting events maintains sort order.
- Test reduction logic (intervals, gaps, active task).
- Test splitting logic.

* Refactor: Phase 3 - Application State
** DONE Define State Struct and Reducers
Create `org-chronos-state.el`:
- Define `chronos-state` struct.
- Implement `(chronos-state-init date)` -> state
- Implement `(chronos-state-next-row state)` -> new state
- Implement `(chronos-state-prev-row state)` -> new state
** DONE Test State Transitions
Create `tests/test-state.el`:
- Test navigation updates `selected-id`.
- Test initialization loads events (mocked).

* Refactor: Phase 4 - UI Layer (Custom Renderer)
** DONE Implement Custom Renderer
Create `org-chronos-render.el`:
- `(chronos-render-buffer state)`: Erases buffer and draws text.
- Implement row highlighting using text properties (`:extend t`, background face) for the `selected-id`.
** DONE Test UI Rendering
Create `tests/test-ui.el`:
- Render a mock state to a temp buffer.
- Assert buffer contains expected strings.
- Assert correct line has the 'selected' face.

* Refactor: Phase 5 - Controller & Integration
** DONE Implement Controller and Main Loop
Create `org-chronos-controller.el`:
- Define keymap.
- Implement command functions that call State reducers and trigger Render.
- Implement `(chronos-refresh)` which reloads FS -> State -> Render.
** DONE Wire Persistence to Actions
Ensure that commands which modify the event list (Clock In, Stop, etc.) trigger `chronos-fs-write`.
